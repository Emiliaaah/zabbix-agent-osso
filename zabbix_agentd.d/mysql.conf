# [This file is part of the zabbix-agent-osso package]
#
# === SETUP ===
#
# # mkdir /etc/zabbix/mysql && cat >/etc/zabbix/mysql/.my.cnf <<EOF
# [client]
# user=zabbix-check
# password=supersecretpasswd
# EOF
# # chown zabbix /etc/zabbix/mysql/.my.cnf
# # chmod 0400 /etc/zabbix/mysql/.my.cnf
#
# mysql> CREATE USER 'zabbix-check'@'localhost' IDENTIFIED BY 'supersecretpasswd';
#
# # For replication monitoring you'll also need this.
# # For the mysql.size[*] checks you'll need even more.
# mysql> GRANT REPLICATION CLIENT ON *.* TO 'zabbix-check'@'localhost';
#
# For table size or max column size monitoring, you'll need usage rights.
# mysql> GRANT SELECT ON *.* TO 'zabbix-check'@'localhost';
#
# === END SETUP ===
#

# MySQL client version
UserParameter=mysql.version, mysql -V

# MySQL checks
UserParameter=mysql.status[*], HOME=/etc/zabbix/mysql mysql -BNe "SHOW GLOBAL STATUS WHERE variable_name='$1';" 2>/dev/null | awk '{print $''2} END {if(!NR)print 0}'
UserParameter=mysql.system[*], HOME=/etc/zabbix/mysql mysql -BNe "SHOW VARIABLES LIKE '$1';" 2>/dev/null | awk '{print $''2} END {if(!NR)print 0}'
UserParameter=mysql.ping, HOME=/etc/zabbix/mysql timeout 2s mysqladmin ping 2>/dev/null | grep -c alive

# MySQL replication
UserParameter=mysql.slave_io_running, HOME=/etc/zabbix/mysql mysql -Be 'SHOW SLAVE STATUS\G' 2>/dev/null | awk '/^ *Slave_IO_Running:/{if($2=="Yes"){i=1;print 1}} END{if(!i)print 0}'
UserParameter=mysql.slave_sql_running, HOME=/etc/zabbix/mysql mysql -Be 'SHOW SLAVE STATUS\G' 2>/dev/null | awk '/^ *Slave_SQL_Running:/{if($2=="Yes"){i=1;print 1}} END{if(!i)print 0}'
UserParameter=mysql.seconds_behind_master, HOME=/etc/zabbix/mysql mysql -Be 'SHOW SLAVE STATUS\G' 2>/dev/null | awk '/^ *Seconds_Behind_Master:/{i=1;print $2} END{if(!i)print 9999}'

# Galera: we use mysql.status_galera instead of mysql.status.
UserParameter=mysql.status_galera[*], HOME=/etc/zabbix/mysql mysql -BNe "SHOW STATUS LIKE '$1';" 2>/dev/null | awk '{print $''2} END {if(!NR)print 0}'

# Flexible parameter to determine database or table size.
# * On the frontend side, use keys like mysql.size[zabbix,history,data].
# * Key syntax is mysql.size[<database>,<table>,<type>].
# * Database may be a database name or "all". Default is "all".
# * Table may be a table name or "all". Default is "all".
# * Type may be "data", "index", "free", "rows" or "both". Both is a sum
#   of data and index. Default is "both".
# * Database is mandatory if a table is specified. Type may always be
#   specified.
# * Returns value in bytes.
# * 'SUM' on data_length or index_length only needed when we are getting
#   this information for whole database instead of a single table
# (Original source: zabbix-agent userparameter_mysql.conf)
UserParameter=mysql.size[*], HOME=/etc/zabbix/mysql mysql -BNe "SELECT SUM(`case "$3" in both|"") echo "data_length+index_length";; data|index) echo "$3_length";; free) echo "data_free";; rows) echo "table_rows";; *) echo "bAd_tYpE";; esac`) FROM information_schema.tables`case "$1" in all|"");; *) echo " WHERE table_schema='$1'";; esac``case "$2" in all|"");; *) echo " AND table_name='$2'";; esac`;"

# Max integer checks (requires select priv on *.*)
UserParameter=mysql.autoinc.max, HOME=/etc/zabbix/mysql mysql -BNe "SELECT t.highest_autoint FROM (SELECT b.auto_increment AS highest_autoint, c.numeric_precision - LENGTH(b.auto_increment) AS precision_left FROM information_schema.columns c INNER JOIN information_schema.tables b ON b.table_schema = c.table_schema AND b.table_name = c.table_name WHERE c.extra = 'auto_increment' AND c.numeric_precision IS NOT NULL) t ORDER BY t.precision_left, t.highest_autoint DESC LIMIT 1;"
UserParameter=mysql.autoinc.column, HOME=/etc/zabbix/mysql mysql -BNe "SELECT CONCAT(t.table_schema, '.', t.table_name, '.', t.column_name) AS col FROM (SELECT b.table_schema, b.table_name, c.column_name, b.auto_increment AS highest_autoint, c.numeric_precision - LENGTH(b.auto_increment) AS precision_left FROM information_schema.columns c INNER JOIN information_schema.tables b ON b.table_schema = c.table_schema AND b.table_name = c.table_name WHERE c.extra = 'auto_increment' AND c.numeric_precision IS NOT NULL) t ORDER BY t.precision_left, t.highest_autoint DESC LIMIT 1;"
