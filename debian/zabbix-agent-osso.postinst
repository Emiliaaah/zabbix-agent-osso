#!/bin/sh
set -e

if [ "$1" = configure ]; then
    # Oooh. Ugly hacks here: some zabbix-agent packages contain a
    # /etc/zabbix/zabbix_agentd.d/userparameter_mysql.conf file which
    # (also) contains mysql.status, mysql.ping, etc..
    # If it exists, disable the config so it doesn't cause duplicate
    # key conflicts with our own mysql.conf.
    if grep -q '^UserParameter=' \
	    /etc/zabbix/zabbix_agentd.d/userparameter_mysql.conf \
	    2>/dev/null; then
        sed -i -e 's/^UserParameter=/#DISABLED_BY_zabbix-agent-osso#/' \
	    /etc/zabbix/zabbix_agentd.d/userparameter_mysql.conf
    fi

    # Make sure a lib directory exists, with zabbix permissions.
    mkdir -p /var/lib/zabbix/scripts
    # Make it writable by zabbix, but do not croak if user is missing.
    chown zabbix:zabbix /var/lib/zabbix/scripts || true

    # Restart zabbix-agent if it was running.
    if systemctl status zabbix-agent >/dev/null 2>&1; then
	systemctl restart zabbix-agent.service
    elif service zabbix-agent status >/dev/null 2>&1; then
	service zabbix-agent restart
    elif /etc/init.d/zabbix-agent status >/dev/null 2>&1; then
	/etc/init.d/zabbix-agent restart
    fi
fi

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
