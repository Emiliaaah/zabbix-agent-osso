<?xml version="1.0" encoding="UTF-8"?>
<zabbix_export>
    <version>4.4</version>
    <date>2019-12-06T13:13:17Z</date>
    <groups>
        <group>
            <name>TEMPLATES</name>
        </group>
    </groups>
    <templates>
        <template>
            <template>Template OSSO Disk ZFS</template>
            <name>Template OSSO Disk ZFS</name>
            <groups>
                <group>
                    <name>TEMPLATES</name>
                </group>
            </groups>
            <applications>
                <application>
                    <name>ZFS</name>
                </application>
            </applications>
            <items>
                <item>
                    <name>ZFS ARC configured max</name>
                    <type>ZABBIX_ACTIVE</type>
                    <key>zfs.arc.max.file</key>
                    <delay>1h</delay>
                    <history>30d</history>
                    <trends>90d</trends>
                    <units>B</units>
                    <applications>
                        <application>
                            <name>ZFS</name>
                        </application>
                    </applications>
                    <request_method>POST</request_method>
                </item>
                <item>
                    <name>ZFS ARC enabled max</name>
                    <type>ZABBIX_ACTIVE</type>
                    <key>zfs.arc.max.sys</key>
                    <delay>1h</delay>
                    <trends>90d</trends>
                    <units>B</units>
                    <applications>
                        <application>
                            <name>ZFS</name>
                        </application>
                    </applications>
                    <request_method>POST</request_method>
                </item>
                <item>
                    <name>ZFS ARC enabled max ratio</name>
                    <type>CALCULATED</type>
                    <key>zfs.arc.max.syspromille</key>
                    <delay>30m</delay>
                    <history>30d</history>
                    <trends>90d</trends>
                    <units>%o</units>
                    <params>1000*last(zfs.arc.max.sys)/last(zfs.memory.exists)</params>
                    <applications>
                        <application>
                            <name>ZFS</name>
                        </application>
                    </applications>
                    <request_method>POST</request_method>
                    <triggers>
                        <trigger>
                            <expression>({last()}&lt;30 or&#13;
 {last()}&gt;850)</expression>
                            <name>ZFS arc max {ITEM.VALUE} not between 30 %o and 850 %o on {HOST.NAME}</name>
                            <priority>DISASTER</priority>
                            <description>Herman says (2017-05-03): &quot;sp servers hebben vaak tot 80% ofzo aan ARC.&#13;
pve nodes hebben van de 128GB, 4GB tot 32GB aan ARC&quot;, i.e. 3%..85%.</description>
                        </trigger>
                    </triggers>
                </item>
                <item>
                    <name>ZFS ARC stat data_size</name>
                    <type>ZABBIX_ACTIVE</type>
                    <key>zfs.arcstats[data_size]</key>
                    <delay>15m</delay>
                    <history>30d</history>
                    <trends>90d</trends>
                    <units>B</units>
                    <applications>
                        <application>
                            <name>ZFS</name>
                        </application>
                    </applications>
                    <request_method>POST</request_method>
                </item>
                <item>
                    <name>ZFS ARC stat hits</name>
                    <type>ZABBIX_ACTIVE</type>
                    <key>zfs.arcstats[hits]</key>
                    <delay>15m</delay>
                    <history>30d</history>
                    <trends>90d</trends>
                    <applications>
                        <application>
                            <name>ZFS</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>CHANGE_PER_SECOND</type>
                            <params/>
                        </step>
                    </preprocessing>
                    <request_method>POST</request_method>
                </item>
                <item>
                    <name>ZFS ARC stat meta</name>
                    <type>ZABBIX_ACTIVE</type>
                    <key>zfs.arcstats[meta]</key>
                    <delay>15m</delay>
                    <history>30d</history>
                    <trends>90d</trends>
                    <units>B</units>
                    <applications>
                        <application>
                            <name>ZFS</name>
                        </application>
                    </applications>
                    <request_method>POST</request_method>
                </item>
                <item>
                    <name>ZFS ARC stat mfu_hits</name>
                    <type>ZABBIX_ACTIVE</type>
                    <key>zfs.arcstats[mfu_hits]</key>
                    <delay>15m</delay>
                    <history>30d</history>
                    <trends>90d</trends>
                    <applications>
                        <application>
                            <name>ZFS</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>CHANGE_PER_SECOND</type>
                            <params/>
                        </step>
                    </preprocessing>
                    <request_method>POST</request_method>
                </item>
                <item>
                    <name>ZFS ARC stat mfu_size</name>
                    <type>ZABBIX_ACTIVE</type>
                    <key>zfs.arcstats[mfu_size]</key>
                    <delay>15m</delay>
                    <history>30d</history>
                    <trends>90d</trends>
                    <units>B</units>
                    <applications>
                        <application>
                            <name>ZFS</name>
                        </application>
                    </applications>
                    <request_method>POST</request_method>
                </item>
                <item>
                    <name>ZFS ARC stat misses</name>
                    <type>ZABBIX_ACTIVE</type>
                    <key>zfs.arcstats[misses]</key>
                    <delay>15m</delay>
                    <history>30d</history>
                    <trends>90d</trends>
                    <applications>
                        <application>
                            <name>ZFS</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>CHANGE_PER_SECOND</type>
                            <params/>
                        </step>
                    </preprocessing>
                    <request_method>POST</request_method>
                </item>
                <item>
                    <name>ZFS ARC stat mru_hits</name>
                    <type>ZABBIX_ACTIVE</type>
                    <key>zfs.arcstats[mru_hits]</key>
                    <delay>15m</delay>
                    <history>30d</history>
                    <trends>90d</trends>
                    <applications>
                        <application>
                            <name>ZFS</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>CHANGE_PER_SECOND</type>
                            <params/>
                        </step>
                    </preprocessing>
                    <request_method>POST</request_method>
                </item>
                <item>
                    <name>ZFS ARC stat mru_size</name>
                    <type>ZABBIX_ACTIVE</type>
                    <key>zfs.arcstats[mru_size]</key>
                    <delay>15m</delay>
                    <history>30d</history>
                    <trends>90d</trends>
                    <units>B</units>
                    <applications>
                        <application>
                            <name>ZFS</name>
                        </application>
                    </applications>
                    <request_method>POST</request_method>
                </item>
                <item>
                    <name>ZFS ARC stat size</name>
                    <type>ZABBIX_ACTIVE</type>
                    <key>zfs.arcstats[size]</key>
                    <delay>15m</delay>
                    <history>30d</history>
                    <trends>90d</trends>
                    <units>B</units>
                    <applications>
                        <application>
                            <name>ZFS</name>
                        </application>
                    </applications>
                    <request_method>POST</request_method>
                </item>
                <item>
                    <name>ZFS ARC cache hit ratio</name>
                    <type>CALCULATED</type>
                    <key>zfs.arcstats_hit_ratio</key>
                    <delay>5m</delay>
                    <history>30d</history>
                    <trends>90d</trends>
                    <units>%o</units>
                    <params>1000*((last(zfs.arcstats[hits])+0.001)/(last(zfs.arcstats[hits])+last(zfs.arcstats[misses])+0.001))</params>
                    <applications>
                        <application>
                            <name>ZFS</name>
                        </application>
                    </applications>
                    <request_method>POST</request_method>
                </item>
                <item>
                    <name>ZFS ARC total read</name>
                    <type>CALCULATED</type>
                    <key>zfs.arcstats_total_read</key>
                    <delay>5m</delay>
                    <history>30d</history>
                    <trends>90d</trends>
                    <units>B</units>
                    <params>last(zfs.arcstats[hits])+last(zfs.arcstats[misses])</params>
                    <applications>
                        <application>
                            <name>ZFS</name>
                        </application>
                    </applications>
                    <request_method>POST</request_method>
                </item>
                <item>
                    <name>ZFS memory machine-total</name>
                    <type>ZABBIX_ACTIVE</type>
                    <key>zfs.memory.exists</key>
                    <delay>1h</delay>
                    <history>30d</history>
                    <trends>90d</trends>
                    <units>B</units>
                    <applications>
                        <application>
                            <name>ZFS</name>
                        </application>
                    </applications>
                    <request_method>POST</request_method>
                </item>
                <item>
                    <name>ZFS memory used</name>
                    <type>ZABBIX_ACTIVE</type>
                    <key>zfs.memory.used</key>
                    <delay>5m</delay>
                    <history>30d</history>
                    <trends>90d</trends>
                    <units>B</units>
                    <applications>
                        <application>
                            <name>ZFS</name>
                        </application>
                    </applications>
                    <request_method>POST</request_method>
                </item>
                <item>
                    <name>ZFS version</name>
                    <type>ZABBIX_ACTIVE</type>
                    <key>zfs.version</key>
                    <delay>1h</delay>
                    <history>30d</history>
                    <trends>0</trends>
                    <value_type>TEXT</value_type>
                    <applications>
                        <application>
                            <name>ZFS</name>
                        </application>
                    </applications>
                    <request_method>POST</request_method>
                    <triggers>
                        <trigger>
                            <expression>{diff(0)}&gt;0</expression>
                            <name>ZFS version is now {ITEM.VALUE} on {HOST.NAME}</name>
                            <priority>INFO</priority>
                        </trigger>
                    </triggers>
                </item>
            </items>
            <discovery_rules>
                <discovery_rule>
                    <name>ZFS dataset discovery</name>
                    <type>ZABBIX_ACTIVE</type>
                    <key>zfs.dataset.discovery</key>
                    <delay>12h</delay>
                    <status>DISABLED</status>
                    <filter>
                        <conditions>
                            <condition>
                                <macro>{#DATASETNAME}</macro>
                                <value>@ZFS fileset</value>
                                <formulaid>A</formulaid>
                            </condition>
                        </conditions>
                    </filter>
                    <lifetime>1w</lifetime>
                    <description>Discover ZFS datasets. Dataset names must contain a &quot;/&quot; else it's a zpool root.</description>
                    <item_prototypes>
                        <item_prototype>
                            <name>ZFS dataset {#DATASETNAME} refer</name>
                            <type>ZABBIX_ACTIVE</type>
                            <key>zfs.dataset.info[{#DATASETNAME},refer]</key>
                            <delay>1h</delay>
                            <history>30d</history>
                            <units>B</units>
                            <applications>
                                <application>
                                    <name>ZFS</name>
                                </application>
                            </applications>
                            <request_method>POST</request_method>
                        </item_prototype>
                        <item_prototype>
                            <name>ZFS dataset {#DATASETNAME} used directly</name>
                            <type>ZABBIX_ACTIVE</type>
                            <key>zfs.dataset.info[{#DATASETNAME},usedds]</key>
                            <delay>1h</delay>
                            <history>30d</history>
                            <units>B</units>
                            <applications>
                                <application>
                                    <name>ZFS</name>
                                </application>
                            </applications>
                            <request_method>POST</request_method>
                        </item_prototype>
                        <item_prototype>
                            <name>ZFS dataset {#DATASETNAME} used snap</name>
                            <type>ZABBIX_ACTIVE</type>
                            <key>zfs.dataset.info[{#DATASETNAME},usedsnap]</key>
                            <delay>1h</delay>
                            <history>30d</history>
                            <units>B</units>
                            <applications>
                                <application>
                                    <name>ZFS</name>
                                </application>
                            </applications>
                            <request_method>POST</request_method>
                        </item_prototype>
                        <item_prototype>
                            <name>ZFS dataset {#DATASETNAME} total used</name>
                            <type>ZABBIX_ACTIVE</type>
                            <key>zfs.dataset.info[{#DATASETNAME},used]</key>
                            <delay>1h</delay>
                            <history>30d</history>
                            <units>B</units>
                            <applications>
                                <application>
                                    <name>ZFS</name>
                                </application>
                            </applications>
                            <request_method>POST</request_method>
                        </item_prototype>
                    </item_prototypes>
                    <request_method>POST</request_method>
                </discovery_rule>
                <discovery_rule>
                    <name>ZFS pool discovery</name>
                    <type>ZABBIX_ACTIVE</type>
                    <key>zfs.pool.discovery</key>
                    <delay>12h</delay>
                    <item_prototypes>
                        <item_prototype>
                            <name>Zpool {#POOLNAME} available</name>
                            <type>ZABBIX_ACTIVE</type>
                            <key>zfs.dataset.info[{#POOLNAME},available]</key>
                            <delay>10m</delay>
                            <history>30d</history>
                            <units>B</units>
                            <description>Yes, the zpool name is also the first dataset, so we can get info from zfs.dataset.info.</description>
                            <applications>
                                <application>
                                    <name>ZFS</name>
                                </application>
                            </applications>
                            <request_method>POST</request_method>
                        </item_prototype>
                        <item_prototype>
                            <name>Zpool {#POOLNAME} used</name>
                            <type>ZABBIX_ACTIVE</type>
                            <key>zfs.dataset.info[{#POOLNAME},used]</key>
                            <delay>1h</delay>
                            <history>30d</history>
                            <units>B</units>
                            <description>Yes, the zpool name is also the first dataset, so we can get info from zfs.dataset.info.</description>
                            <applications>
                                <application>
                                    <name>ZFS</name>
                                </application>
                            </applications>
                            <request_method>POST</request_method>
                        </item_prototype>
                        <item_prototype>
                            <name>Zpool {#POOLNAME} health</name>
                            <type>ZABBIX_ACTIVE</type>
                            <key>zfs.zpool.health[{#POOLNAME}]</key>
                            <delay>10m</delay>
                            <history>30d</history>
                            <trends>0</trends>
                            <value_type>TEXT</value_type>
                            <applications>
                                <application>
                                    <name>ZFS</name>
                                </application>
                            </applications>
                            <request_method>POST</request_method>
                            <trigger_prototypes>
                                <trigger_prototype>
                                    <expression>{str(&quot;ONLINE&quot;)}&lt;&gt;1</expression>
                                    <name>Zpool {#POOLNAME} is {ITEM.LASTVALUE} on {HOST.NAME}</name>
                                    <priority>DISASTER</priority>
                                </trigger_prototype>
                            </trigger_prototypes>
                        </item_prototype>
                    </item_prototypes>
                    <trigger_prototypes>
                        <trigger_prototype>
                            <expression>({Template OSSO Disk ZFS:zfs.dataset.info[{#POOLNAME},available].last()}*100/({Template OSSO Disk ZFS:zfs.dataset.info[{#POOLNAME},available].last()}+{Template OSSO Disk ZFS:zfs.dataset.info[{#POOLNAME},used].last()}))&lt;2</expression>
                            <name>Zpool {#POOLNAME} on {HOST.NAME} has less than $2% space</name>
                            <priority>DISASTER</priority>
                        </trigger_prototype>
                        <trigger_prototype>
                            <expression>({Template OSSO Disk ZFS:zfs.dataset.info[{#POOLNAME},available].last()}*100/({Template OSSO Disk ZFS:zfs.dataset.info[{#POOLNAME},available].last()}+{Template OSSO Disk ZFS:zfs.dataset.info[{#POOLNAME},used].last()}))&lt;10</expression>
                            <name>Zpool {#POOLNAME} on {HOST.NAME} has less than $2% space</name>
                            <priority>HIGH</priority>
                        </trigger_prototype>
                    </trigger_prototypes>
                    <request_method>POST</request_method>
                </discovery_rule>
            </discovery_rules>
        </template>
    </templates>
    <triggers>
        <trigger>
            <expression>{Template OSSO Disk ZFS:zfs.arc.max.file.last()}&lt;&gt;{Template OSSO Disk ZFS:zfs.arc.max.sys.last()}</expression>
            <name>ZFS arc max config is not applied on {HOST.NAME} (conf={ITEM.LASTVALUE1}, sys={ITEM.LASTVALUE2})</name>
            <priority>DISASTER</priority>
            <description>If the zfs_arc_max is not configured, it's 0 both in the config and the system. But that problem is picked up by the other trigger that wants the max between 3% and 85%.</description>
        </trigger>
    </triggers>
</zabbix_export>
